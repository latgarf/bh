{% extends 'base.htm' %}
{% block content %}
<style>
	.row-fluid .span3 {margin:10px 0 10px;}
	.row-fluid .span4 {margin:10px 0 10px;}
	.row-fluid .span5 {margin:10px 0 10px;}
	.row-fluid .span6 {margin:10px 0 10px;}

	.form-label {font-size: 1.2em; font-weight:800; color:#2a9cc1;}
	.form-actions {float:right; padding-top:0; background:none; border:none;}
	.form-inline-text {margin-top:5px; h4 {padding-left:20px;}}

	.info div {font-size:3em;}
	.info label {color:#2a9cc1; font-size:16px;}

	.homepage-header {font-size:3.75em; font-weight:900; text-align:center; margin-top:5%;}
	.homepage-text {font-size:1.25em; margin-top:3%; text-align:center; color:black;}
	.header2 {margin:3% 0 2%; font-size:2em; font-weight:900; text-align:left;}

	.btc_address_our {margin:1% 0 1%; font-size:1.5em; color:red;}
	.submit-confirm {background-color:#FFFAB2;}
</style>


<div class="homepage-header blue">Bitcoin Options, Futures, and<br>Exchange Rate Insurance</div>

<div class="homepage-text">
	No sign up required! &nbsp; Payments only with bitcoins.<br>
	We will pay you the difference between the current BTC/USD rate <br>and the rate at your chosen expiry date (at 21:00 <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a>).
	<br>The insurance is based on the 24-hour average rate from <a href="https://bitstamp.net">Bitstamp</a>.
</div>

<div class="header2 blue">Select Insurance Parameters</div>

<!------------------------------------------------------------------------------>

<div class="row-fluid">

<form class="form-inline" id="contractForm" action="" onsubmit="return validateForm()" method="POST">
	{% csrf_token %}
    <input type="hidden" value="{{ma_rate}}" name="rate" />
    <input type="hidden" value="a" name="bh_address" />

	<div class="row-fluid">
	    <div class="span4"><label class="control-label form-label" for="protect_direction">INSURE FROM &nbsp;&nbsp;&nbsp;</label>
        </div>
        <div class="span6">
			<select id="protect_direction" onchange="refreshFee()" name="select_direction">
				<option value="0">DECREASE in bitcoin value vs USD</option>
				<option value="1">INCREASE in bitcoin value vs USD</option>
			</select>
	    </div>
	</div>

	<div class="row-fluid">
		<div class="span4"><label class="control-label form-label" for="id_date">EXPIRY &nbsp;&nbsp;&nbsp;&nbsp;</label>
		</div>

		<div class="span6 controls input-append date" id="datetimepicker" data-date="{{date}}" data-date-format="yyyy-mm-dd">
			<input type="text" class="input-medium" name="date" id="id_date" value="{{date}}">
			<span class="add-on"><i data-time-icon="icon-time" data-date-icon="icon-calendar"></i></span>
		</div>
	</div>

<!-- Original datetimepicker code:

        <div id="datetimepicker" class="input-append date">
          <input type="text"></input>
          <span class="add-on">
            <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
          </span>
        </div>
-->

<!-- BH original DatePicker row in table of insurance parameters (drop-down calendar)

	<div class="row-fluid">
		<div class="span4"><label class="control-label form-label" for="id_date">EXPIRY DATE &nbsp;&nbsp;&nbsp;&nbsp;</label>
		</div>
		<div class="span6 controls input-append date" id="dp" data-date="{{date}}" data-date-format="yyyy-mm-dd">
			<input type="text" class="input-medium" name="date" id="id_date" value="{{date}}">
			<span class="add-on"><i class="icon-calendar"></i></span>
		</div>
	</div>
-->

	<div class="row-fluid">

	    <div class="span4"><label class="control-label form-label" for="id_amount">AMOUNT TO INSURE &nbsp;&nbsp;&nbsp;&nbsp;</label>
	    </div>

	    <div class="span3"><input class="controls input-append input-medium" type="text" name="amount" id="id_amount" value="{{trgAmount}}">
		</div>

		<div class="span5 blue">Minimum: 0.1 &nbsp;&nbsp;&nbsp;&nbsp; Maximum: 1 bitcoin</p>
		</div>

	</div>

	<div class="row-fluid">
		<div class="span4"><label class="form-control control-label form-label" for="id_address">YOUR BITCOIN ADDRESS &nbsp;&nbsp;&nbsp;&nbsp;</label>
		</div>
		<div class="span6"><input class="controls input-append input-medium" type="text" name="address" id="id_address">
		</div>
	</div>
</form>

<div class="info">
	<label class="control-label blue" for="id_fee"><br><b>INSURANCE FEE</b>&nbsp; (bitcoins)<b>:</b></label>
    <div class="controls blue" id="id_fee" name="fee">{{fee}}</div>
    <div id="id_testdate"> </div>
</div>

<br><button type="submit" class="btn btn-primary" onclick="return submit_and_countdown()">Place Order</button><br><br>
</div>
<!------------------------------------------------------------------------------>

<div id="submit_confirm" class="submit-confirm">
    <hr>
    You order was received!

	<div class="btc_address_our">
	    <section id="id_bh_address">
	        <div id="btc_addr_our"><b>Pay the insurance fee within 5 minutes to this bitcoin address:</b>
		        <span id="id_address_our">a</span>
		        <br>Otherwise, your order will be cancelled.
		    </div>
	    </section>
	</div>

	<br>You can <a href="/future/query/">check status of your order</a> by using order ID: &nbsp;<span id="order_id" class="controls blue bold"></span>

	<hr>

</div>


<script type="text/javascript">
    $(document).ready(function() {
        $("#id_bh_address").hide();
        $("#submit_confirm").hide();
    })
</script>


<script>
    function refreshFee() {
        var form = $('#contractForm');

        var a = Number(document.getElementById('id_amount').value)
        if(a <= 0) {
            $("#id_fee").text(Number(0).toFixed(8));
            return 0;
        }

        $.ajax({
            url: "/future/premium/",
            type: "POST",
            data: form.serialize(),
            success: function(data) {
                $("#id_fee").text(data.fee);
                $("#id_fee_usd").text(data.fee_usd);
                $("#rate").text(data.rate)
            },
            error: function(data) {
                {# alert('error')#}
            }
        });
    }

    function validateForm() {
        var message = "";

        // date
        var dvalue = document.getElementById('id_date').value;
        if(dvalue.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
            var dt = new Date(dvalue);
            var today = new Date()
            if(dt < today)
                message += "Date should be no earlier than today!\n";
           
            today.setDate(today.getDate()+7)
            if(dt > today)
                message += "Date should be within 7 days from today!\n";
        }
        else
            message += "Not a YYYY-MM-DD format date: '" + dvalue + "'\n";

        // amount
        var amount = document.getElementById('id_amount').value
        if(isNaN(parseFloat(amount)) || !isFinite(amount)) {
            message += "Amount must be a number!\n";
        } else {
            a = Number(amount);
            if(a <0.1 || a > 1) {
                message += "Amount must between 0.1 and 1 bitcoins!\n"
            }
        }

        // btc address
        var add = document.getElementById('id_address').value
        if(! check(add)) {
            message += "Invalid Bitcoind address!\n";
        }

        return message;
    }

    function submit_and_countdown() {
        var err_msg = validateForm();
        if(err_msg != "") {
            alert(err_msg);
            return false;
        }

        var form = $('#contractForm');
        $.ajax({
            url: "/future/",
            type: "POST",
            data: form.serialize(),
            success: function(data) {
                if(data.duplicated){
                    alert("Order already submitted!");
                    return false;
                }

                $("#ord_exp_time").text(data.ord_exp_time);
                $("#order_id").text(data.order_id);
                $("#id_address_our").text(data.address);
                $("#id_bh_address").show();
                $("#submit_confirm").show();
            },
            error: function(data) {
                {# alert('error')#}
            }
        });

        return true;
    }

    $('#dp').datepicker().on('changeDate', function(ev){refreshFee()});
    $('#id_amount, #id_date').on('input', function() {refreshFee()});

</script>

<!----------------------  DateTimePicker  ------------------------------------------------------->
<!--
<div id="datetimepicker" class="input-append date">
  <input type="text"></input>
  <span class="add-on">
    <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
  </span>
</div>
-->
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script> 
<script type="text/javascript" src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://tarruda.github.com/bootstrap-datetimepicker/assets/js/bootstrap-datetimepicker.min.js"></script>
<script type="text/javascript" src="http://tarruda.github.com/bootstrap-datetimepicker/assets/js/bootstrap-datetimepicker.pt-BR.js"></script>

<script type="text/javascript">
  $('#datetimepicker').datetimepicker({ format: 'yyyy-MM-dd hh:mm', language: 'en-US' });
</script>


{% endblock content %}
